"""
Exploit data models.
"""

from sqlalchemy import Column, Integer, String, Text, DateTime, Enum as SQLEnum
from sqlalchemy.sql import func
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional, List
from enum import Enum

from .database import Base


class PlatformType(str, Enum):
    """Supported platform types."""
    PHP = "php"
    ASP = "asp"
    ASPX = "aspx"
    JSP = "jsp"
    JAVA = "java"
    PYTHON = "python"
    RUBY = "ruby"
    NODEJS = "nodejs"
    MULTIPLE = "multiple"
    OTHER = "other"


class SoftwareType(str, Enum):
    """Software category types."""
    CMS = "cms"
    FRAMEWORK = "framework"
    MODULE = "module"
    PLUGIN = "plugin"
    SHOPPING_CART = "shopping_cart"
    FORUM = "forum"
    WIKI = "wiki"
    BLOG = "blog"
    E_COMMERCE = "e_commerce"
    OTHER = "other"


class ExploitType(str, Enum):
    """Types of exploits."""
    SQL_INJECTION = "sqli"
    XSS = "xss"
    RCE = "rce"
    LFI = "lfi"
    RFI = "rfi"
    CSRF = "csrf"
    AUTH_BYPASS = "auth_bypass"
    FILE_UPLOAD = "file_upload"
    SSRF = "ssrf"
    XXE = "xxe"
    DESERIALIZATION = "deserialization"
    OTHER = "other"


class SeverityLevel(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class Exploit(Base):
    """Database model for exploits."""
    
    __tablename__ = "exploits"
    
    id = Column(Integer, primary_key=True, index=True)
    exploit_db_id = Column(String(50), unique=True, index=True, nullable=True)
    title = Column(String(500), nullable=False)
    description = Column(Text)
    
    # Classification
    platform = Column(String(50))
    software_type = Column(String(50))
    exploit_type = Column(String(50))
    severity = Column(String(20), default="medium")
    
    # Affected software
    software_name = Column(String(200))
    software_version = Column(String(100))
    vendor = Column(String(200))
    
    # Technical details
    cve_id = Column(String(50), index=True)
    cvss_score = Column(String(10))
    author = Column(String(200))
    
    # Content
    exploit_code = Column(Text)
    proof_of_concept = Column(Text)
    
    # Solutions
    solution = Column(Text)
    mitigation = Column(Text)
    references = Column(Text)  # JSON array of URLs
    
    # Metadata
    source_url = Column(String(500))
    published_date = Column(DateTime)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())


# Pydantic models for API
class ExploitBase(BaseModel):
    """Base exploit schema."""
    title: str
    description: Optional[str] = None
    platform: Optional[str] = None
    software_type: Optional[str] = None
    exploit_type: Optional[str] = None
    severity: Optional[str] = "medium"
    software_name: Optional[str] = None
    software_version: Optional[str] = None
    vendor: Optional[str] = None
    cve_id: Optional[str] = None
    cvss_score: Optional[str] = None
    author: Optional[str] = None
    exploit_code: Optional[str] = None
    proof_of_concept: Optional[str] = None
    solution: Optional[str] = None
    mitigation: Optional[str] = None
    references: Optional[str] = None
    source_url: Optional[str] = None
    published_date: Optional[datetime] = None


class ExploitCreate(ExploitBase):
    """Schema for creating exploits."""
    exploit_db_id: Optional[str] = None


class ExploitResponse(ExploitBase):
    """Schema for exploit responses."""
    id: int
    exploit_db_id: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True


class ExploitListResponse(BaseModel):
    """Schema for paginated exploit list."""
    items: List[ExploitResponse]
    total: int
    page: int
    page_size: int
    has_next: bool
